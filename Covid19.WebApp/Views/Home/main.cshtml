@{
    ViewData["Title"] = "Αρχική σελίδα";
}


@section Styles {
    <link rel="stylesheet" href="~/lib/leaflet/leaflet.min.css" />
    <link href="~/css/Leaflet.PolylineMeasure.css" rel="stylesheet" />
    <link href="~/css/L.Control.Sidebar.css" rel="stylesheet" />
    <link href="~/css/L.Control.Sidebar.css" rel="stylesheet" />
    <link href="~/css/easy-button.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/lib/leaflet-fullscreen/Control.FullScreen.css" />
    <style type="text/css">
        #map {
            height: 800px;
            margin: 20px 20px 0 0;
        }

        .col-xs-12, .col-xs-12, .col-xs-4 {
            padding: 3px;
        }

        #divProject {
            background-color: beige;
        }

        .errorMsg {
            padding: 0;
            text-align: center;
            background-color: darksalmon;
        }
    </style>
}

@section Scripts {
    <script type="text/javascript" src="~/lib/jquery-csv/jquery.csv.min.js"></script>
    <script src="https://use.fontawesome.com/6024ab1387.js"></script>
    <script type="text/javascript" src="~/lib/leaflet/leaflet.min.js"></script>
    <script type="text/javascript" src="~/lib/leaflet/leaflet.js"></script>
    <script type="text/javascript" src="~/lib/leaflet-fullscreen/Control.FullScreen.min.js"></script>
    <script src="~/js/leaflet.ajax.min.js"></script>
    <script src="~/lib/leaflet/plugins/L.Control.Sidebar.js"></script>
    <script src="~/lib/leaflet/plugins/L.Control.Sidebar.js"></script>
    <script src="~/lib/leaflet/plugins/easy-button.js"></script>
    <script src="~/lib/leaflet/plugins/Leaflet.PolylineMeasure.js"></script>
    <script src="~/lib/leaflet/plugins/leaflet-providers.js"></script>
    <script type="text/javascript">


        var currentPosition = new L.LatLng(38.144699504115366, 23.857665042524335);
        var mymap;
        var lyrOSM;
        var layerFiltered;
        var layerGraves;
        var layerTotalGraves;
        var objOverlays;
        var ctrlMeasure;
        var objOverlays;
        var ctrLayers;
        var objBaseMaps;
        var sideBar;
        var ctlSidebar;
        var ctlEasybutton;
        var lyrSearch;

        $(document).ready(function() {
            mymap = L.map('map', { center: currentPosition, zoom: 9, editable: true, fullscreenControl: true });

            lyrOSM = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',
                {
                    maxZoom: 24,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                });
            mymap.addLayer(lyrOSM);

            sidebar = L.control.sidebar('sidebar',
                {
                    position: 'right'
                });

            mymap.addControl(sidebar);

            layerGraves = L.geoJSON.ajax('/data/agiosstefanosfinal.json', { style: styleClientLinears, onEachFeature: processClientLinears, filter: filteredLayer }).addTo(mymap);
            layerTotalGraves = L.geoJSON.ajax('/data/agiosstefanosfinal.json', { style: styleClientLinears, onEachFeature: processClientLinears }).addTo(mymap);


            ctlSidebar = L.control.sidebar('search-sidebar').addTo(mymap);

            ctlEasybutton = L.easyButton('fa fa-search', function () {
                ctlSidebar.toggle();
            }).addTo(mymap);


             @*layerGraves.on('click',
                function(e) {
                    sidebar.toggle();
                    var name = e.target.feature.properties.OID_;
                     $(".nome").innerHTML = "Name: " + name;
                });*@


            objOverlays = { "Graves not In Use ": layerGraves, "Total Graves Capacity ": layerTotalGraves};
            ctrLayers = L.control.layers(objBaseMaps, objOverlays).addTo(mymap);

            layerGraves.on('data:loaded',
                function() {
                    mymap.fitBounds(layerGraves.getBounds());
                });

            ctrlMeasure = L.control.polylineMeasure().addTo(mymap);

        });

        function processClientLinears(feature, layer) {
            layer.bindPopup('Αριθμός Τάφου ' + feature.properties.OID_);
            layer.on('click', function (e) { openSidebar(e) });
            layer.on('mouseover', function () { layer.openPopup(); });
        };

        function openSidebar(selection) {
            sidebar.toggle();
            document.getElementById('grave').textContent = selection.target.feature.properties.OID_;
        }

        function filteredLayer(json) {
            var att = json.properties;
            if (att.OID_ < 510) {
                return false;
            } else {
                return true;
            }
        }

        function processFiltered(json, lyr) {
            var att = json.properties;
            label = 'Αρίθμηση Τάφου :' + att.OID_ + '</p>';
            sidebar.setContent('test <b>test</b> test' + label);
            lyr.bindTooltip(label);
        }

        function styleClientLinears(json) {
            var att = json.properties;
            if (att.OID_ < 510) {
                return { color: '#874B8B' };
            } else {
                return { color: '#2C169F' };
            }
        }

        //***********************Search Functions**************

        function returnGraveById(id) {

            var aLayers = layerTotalGraves.getLayers();

            for (var i = 0; i < aLayers.length - 1; i++) {
                var featureId = aLayers[i].feature.properties.OID_;
                if (featureId == id) {
                    return aLayers[i];
                }
            }
            return false;
        }


        $("#btnFindProject").click(function () {
            var id = $("#txtFindProject").val();
            console.log(id);
            var lyr = returnGraveById(id);
            if (lyr) {
                if (lyrSearch) {
                    lyrSearch.remove();
                }
                lyrSearch = L.geoJSON(lyr.toGeoJSON(), { style: { color: 'red', weight: 10, opacity: 0.5 } }).addTo(mymap);
                mymap.fitBounds(lyr.getBounds().pad(5));
                var att = lyr.feature.properties;
                $("#divProjectData").html("Τάφος : " + att.OID_);
            } else {
                $("#divProjectError").html("Ο τάφος δεν βράθηκε");
            }
        });


    </script>
}

<div class="text-center">
    <h1 class="display-4">Alfaware</h1>
</div>

<div class="">
    <div class="">
        <h2>Simulation</h2>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-12 text-center">
                    <h4>Visualize Graves</h4>
                </div>
            </div>
        </div>
    </div>
    <div class="">
        <div class="row">
            <div class="col-md-12">
                <div id="map"></div>
            </div>
            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <p>&nbsp;</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="sidebar">
    <h1>Λεπτομέρεις Τάφου </h1>

    <h5><strong>Επιλεγμένος Τάφος : </strong><span id="grave"></span> </h5>
    <p><b>Εικόνα Τάφου </b></p>

    <img src="~/foto/test.jpg" width="400" height="300" />

</div>

<div id="map"></div>

<div id="search-sidebar">
    <button id="btnLocate" class="btn btn-primary btn-block">Αναζήτηση Τάφων</button><br />
    <div id="divProject">
        <div id="divProjectLabel" class="text-center">
            <h4>Τάφος</h4>
        </div>
        <div id="divProjectError" class="errorMsg"></div>
        <div id="divFindProject" class="form-group">
            <div>
                <input type="text" id="txtFindProject" class="form-control" placeholder="Αριθμός Τάφου" />
            </div>
            <div>
                <button id="btnFindProject" class="btn btn-primary btn-block">Εύρεση Τάφου</button>
            </div>
        </div>
        <div class="" id="divProjectData"></div>
    </div>
</div>